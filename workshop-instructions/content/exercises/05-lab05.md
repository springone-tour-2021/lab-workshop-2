# Deploy Color Application To Kubernetes Without Spring Cloud Kubernetes

## Removing Spring Cloud Kubernetes And Relying On Kubernetes

Spring Cloud provides nice abstractions around things like load balancing, service discovery, and configuration that allows you to run your applications on multiple cloud platforms with little to no changes of the code base.
If however you have determined you only want to deploy your applications to Kubernetes and don't want or need the abstractions you can rely on the cloud native features of Kubernetes directly in which case you can remove Spring Cloud Kubernetes from the applications.

### Remove The Spring Cloud Kubernetes Dependencies


Execute the following `sed` commands to remove the Spring Cloud Kubernetes dependencies from the application POM files.

```execute-1
sed -i '29,36d' ~/color-app/authgateway/pom.xml
sed -i '29,36d' ~/color-app/blueorgreengateway/pom.xml
sed -i '29,36d' ~/color-app/blueorgreenfrontend/pom.xml
```

### Remove The Use Of Spring Cloud LoadBalancer

Service resources in Kubernetes provide load balancing across PODs so we can remove the use of Spring Cloud Loadbalancer.

In the `authgateway` application we have a load balanced route.
Use the following action button to view the line where it is used.

```editor:select-matching-text
file: ~/color-app/authgateway/src/main/java/org/springframework/cloud/samples/authgateway/AuthgatewayApplication.java
text: "lb://blueorgreengateway"
```

Execute the following command to replace the `lb` protocol with `http`.

```execute-1
sed -i s/lb:/http:/g ~/color-app/authgateway/src/main/java/org/springframework/cloud/samples/authgateway/AuthgatewayApplication.java
```

In the `blueorgreenfrontend` application we are using a `@LoadBalanced` `RestTemplate`.
Use the following action button to view the line where it is used.

```editor:select-matching-text
file: ~/color-app/blueorgreenfrontend/src/main/java/org/springframework/demo/BlueOrGreenFrontendApplication.java
text: "@LoadBalanced"
```

Execute the following command to remove the `@LoadBalanced` annotation.

```execute-1
sed -i s/@LoadBalanced//g ~/color-app/blueorgreenfrontend/src/main/java/org/springframework/demo/BlueOrGreenFrontendApplication.java
```

In the `blueorgreengateway` application we are again using load balanced routes.
Use the following action buttons to view the lines where they are used.

```editor:select-matching-text
file: ~/color-app/blueorgreengateway/src/main/java/org/springframework/demo/blueorgreengateway/BlueorgreengatewayApplication.java
text: "lb://blueorgreen-nonpremium"
```

```editor:select-matching-text
file: ~/color-app/blueorgreengateway/src/main/java/org/springframework/demo/blueorgreengateway/BlueorgreengatewayApplication.java
text: "lb://blueorgreen-premium"
```

```editor:select-matching-text
file: ~/color-app/blueorgreengateway/src/main/java/org/springframework/demo/blueorgreengateway/BlueorgreengatewayApplication.java
text: "lb://blueorgreenfrontend"
```

Execute the following command to replace the `lb` protocol with `http`.

```execute-1
sed -i s/lb:/http:/g ~/color-app/blueorgreengateway/src/main/java/org/springframework/demo/blueorgreengateway/BlueorgreengatewayApplication.java
```

In addition we have a `@LoadBalancerClient` annotation that we no longer need as well.

```editor:select-matching-text
file: ~/color-app/blueorgreengateway/src/main/java/org/springframework/demo/blueorgreengateway/BlueorgreengatewayApplication.java
text: "@LoadBalancerClient"
```

Execute the following command to remove the `@LoadBalancerClient` annotation.

```execute-1
sed -i '19,19d' ~/color-app/blueorgreengateway/src/main/java/org/springframework/demo/blueorgreengateway/BlueorgreengatewayApplication.java
sed -i '9,9d' ~/color-app/blueorgreengateway/src/main/java/org/springframework/demo/blueorgreengateway/BlueorgreengatewayApplication.java
```

Since we no longer need any load balancer client configuration we can remove `LoadBalancerConfiguration`.

```execute-1
rm ~/color-app/blueorgreengateway/src/main/java/org/springframework/demo/blueorgreengateway/LoadBalancerConfiguration.java
```

Now that we have removed all the code we need we can build images for our new implementations, push them to our registry and redeploy the applications.

Remove the deployments and services from Kubernetes using the following command.

```execute-1
kubectl delete -Rf ~/color-app/k8s
```
Build new images for the apps using the following command.

```execute-1
cd blueorgreenfrontend/ && ./mvnw spring-boot:build-image -D skipTests && cd ../
cd blueorgreengateway/ && ./mvnw spring-boot:build-image -D skipTests && cd ../
cd authgateway/ && ./mvnw spring-boot:build-image -D skipTests && cd ../
```

Push the new images to our registry using the following command.

```execute-1
docker tag blueorgreenfrontend:0.0.1-SNAPSHOT $REGISTRY_HOST/color-app/blueorgreenfrontend
docker push $REGISTRY_HOST/color-app/blueorgreenfrontend

docker tag blueorgreengateway:0.0.1-SNAPSHOT $REGISTRY_HOST/color-app/blueorgreengateway
docker push $REGISTRY_HOST/color-app/blueorgreengateway

docker tag authgateway:0.0.1-SNAPSHOT $REGISTRY_HOST/color-app/authgateway
docker push $REGISTRY_HOST/color-app/authgateway
```

```execute-1
kubectl apply -Rf ~/color-app/k8s
```

To `watch` the deployments happen run the following command

```execute-1
watch -n 1 kubectl get all
```

### Test The Color Application

You can open the `authgateway` and test out the premium and non-premium use cases.

Premium username: `premium`
Premium password: `pw`

Non-premium username: `user`
Non-premium password: `pw`

Use the following action button to open the `authgateway`.

```dashboard:open-url
url: http://blueorgreenauthgateway-{{ session_namespace }}.{{ ingress_domain }}
```

You can use the following action button to log out.

```dashboard:open-url
url: http://blueorgreenauthgateway-{{ session_namespace }}.{{ ingress_domain }}/logout
```

If you refresh the app in your browser you will likely notice little to none load balancing occuring, in other words you will
likely see the same color returned everytime you refresh.

Load balancing is very "sticky" with Kubernetes services however it will load balance requests if you make a lot of requests.
The easiest way to show this is to run some scripts in a POD running on Kubernetes. 

Execute the following command to run a POD that will open a `bash` terminal allowing you to run some commands inside a POD.

```execute-2
kubectl run --rm utils -it --image yenigul/dockernettools bash
```

Once you see a `bash` prompt run the following command to make several hundred requests to the `blueorgreengateway` and observe the 
colors returned.

 ```execute-2
 x=1; while [ $x -le 500 ]; do curl http://blueorgreengateway/blueorgreen; (( x++ )); done
 ```
As this runs you should see the color returned change every so often.

You can now exit the running POD by executing the following command.


 ```execute-2
 exit
 ```

In the local deployment, all apps connect to Config Server at `localhost:8888` and to Eureka Server at `localhost:8761`.
In addition, all apps register their direct address (IP:port) in Eureka, so that the gateways can communicate with them.

This will not work on Kubernetes.
Instead, all inter-app communication must go through the service resources.
This means that each app must connect to Config Server and EurekaServer through the `configserver` and `eurekaserver` services, respectively, and that each app must register itself in Eureka using its service name (e.g. the blue app must register itself using `blue`).
